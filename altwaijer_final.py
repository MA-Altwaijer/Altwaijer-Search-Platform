import streamlit as st
import pandas as pd
import re

# 1. ุฅุนุฏุงุฏุงุช ุงูููุตุฉ ุงูุฃูุงุฏูููุฉ ุงูุดุงููุฉ - ุฅุตุฏุงุฑ ุฏ. ูุจุฑููุฉ ุงูุชููุฌุฑ
st.set_page_config(page_title="Altwaijer Systematic Review Pro", layout="wide")
st.markdown("<h1 style='text-align:center; color: #1E3A8A;'>๐ ููุตุฉ M.A. Altwaijer ูููุฑุงุฌุนุฉ ุงููููุฌูุฉ ุงููุชูุงููุฉ</h1>", unsafe_allow_html=True)
st.markdown("<h4 style='text-align:center;'>ุงูููุงุฑูุฉ ุงููููุฌูุฉุ ูุฑุงุฌุนุฉ ุงูุฃุฏุจูุงุชุ ูุชูุธูู ุงูุฏุฑุงุณุงุช ุงูุณุงุจูุฉ</h4>", unsafe_allow_html=True)

# 2. ูุญุฑู ุงูุฑูุงุจุท ุงูุนุงูููุฉ (Semantic Scholar, Twigale, ERIC)
def get_global_links(query):
    q = query.replace(" ", "+")
    return {
        "Semantic Scholar": f"https://www.semanticscholar.org/search?q={q}",
        "Twigale": f"https://twigale.com/search?q={q}",
        "ERIC": f"https://eric.ed.gov/?q={q}",
        "Google Scholar": f"https://scholar.google.com/scholar?q={q}"
    }

# 3. ูุงุฌูุฉ ุฑูุน ุงููููุงุช (PDF)
uploaded_files = st.file_uploader("๐ ุงุฑูุนู ุงูุฏุฑุงุณุงุช ุงูุณุงุจูุฉ (ูููููู ุฑูุน ุญุชู 70 ุจุญุซุงู):", type="pdf", accept_multiple_files=True)

if uploaded_files:
    # ุฅูุดุงุก ูุตูููุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุจูุงุกู ุนูู ุทูุจ ุงูุฏูุชูุฑุฉ
    initial_data = []
    for f in uploaded_files:
        # ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ ุงูุณูุฉ ูู ุงุณู ุงูููู (ูุซูุงู: ุฏุฑุงุณุฉ 2022.pdf)
        year_search = re.findall(r'20\d{2}', f.name)
        year = year_search[0] if year_search else "ุบูุฑ ูุญุฏุฏ"
        
        initial_data.append({
            "ุงุณู ุงูุฏุฑุงุณุฉ": f.name,
            "ุงููุคูู": "ุงุณู ุงูุจุงุญุซ",
            "ุงูุณูุฉ": year,
            "ุงูุจูุฏ": "ุนุฑุจูุฉ/ูุญููุฉ",
            "ุงููุฏู": "ุงุณุชูุดุงู ุงููุฌูุงุช ุงููุบููุฉ ูุงูุชุฑุจููุฉ",
            "ุงููููุฌ": "ูุตูู ุชุญูููู",
            "ุงูุฃุฏุงุฉ": "ุงุณุชุจุงูุฉ/ุงุฎุชุจุงุฑ",
            "ุงูุนููุฉ": "ุทูุงุจ/ูุนูููู",
            "ุงููุชุงุฆุฌ": "ูุฌูุฏ ูุฌูุฉ ุชุนููููุฉ ุชุชุทูุจ ูุนุงูุฌุฉ ุฅุฌุฑุงุฆูุฉ."
        })
    
    # ุชุญููู ุงูุจูุงูุงุช ุฅูู ุฌุฏูู ุชูุงุนูู
    df = pd.DataFrame(initial_data)

    # 4. ููุญุฉ ุงูุชุนุฏูู ุงูุชูุงุนููุฉ (Data Editor)
    st.subheader("๐ ูุฑุงุฌุนุฉ ูุชุนุฏูู ุฃุฏุจูุงุช ุงูุฏุฑุงุณุฉ (ุฃุฑุถูุฉ ุงูุจุญุซ)")
    st.info("๐ก ูููููู ุงูููุฑ ุนูู ุฃู ุฎููุฉ ูุชุตุญูุญ ุงูุจูุงูุงุช (ุงููุคููุ ุงูุณูุฉุ ุงููุชุงุฆุฌ..) ูุถูุงู ุงูุฏูุฉ ุงูุนูููุฉ.")
    
    # ุชูุนูู ูุญุฑุฑ ุงูุจูุงูุงุช
    edited_df = st.data_editor(df, num_rows="dynamic", use_container_width=True)

    # 5. ุฒุฑ ุงููุนุงูุฌุฉ ุงูููุงุฆูุฉ ูุตูุงุบุฉ ุงูุฎุทุฉ
    if st.button("๐ ุงุนุชูุงุฏ ุงููุฑุงุฌุนุฉ ุงููููุฌูุฉ ูุตูุงุบุฉ ุงูููุชุฑุญ"):
        st.markdown("---")
        
        # ุตูุงุบุฉ ุงูุนููุงู ุงูุชุฌููุนู
        count = len(edited_df)
        final_title = f"ุชุทููุฑ ุฅุทุงุฑ ุนูู ูุณุฏ ุงููุฌูุงุช ุงููุบููุฉ ูุงูุชุฑุจููุฉ: ุฑุคูุฉ ุชุฌููุนูุฉ ูุณุชุฎูุตุฉ ูู {count} ูุฑุงุฌุน"
        
        st.subheader("๐ ุชูุฑูุฑ ุงูุงุณุชุฎูุงุต ูุงูููุฏ ุงูุนููู (Synthesis Report)")
        
        # ุงูุชุนููู ุงูููุงุฑู (ุงูุชุดุงุจู ูุงูุงุฎุชูุงู)
        st.success(f"""
        ุงูุนููุงู ุงูุฌุฏูุฏ ุงูููุชุฑุญ: "{final_title}"
        
        ุฃููุงู: ุงูุชุนููู ุนูู ุงูุฏุฑุงุณุงุช (ุฃูุฌู ุงูุชุดุงุจู ูุงูุงุฎุชูุงู):
        ุงุชููุช ุงูุฏุฑุงุณุงุช ุงููุฑููุนุฉ ูู ุงุณุชุฎุฏุงู ุงููููุฌ ({edited_df['ุงููููุฌ'].iloc[0]}) ูุงูุชุฑููุฒ ุนูู ุงูุนููุงุช ุงูุชุนููููุฉุ ุจูููุง ุชุจุงููุช ูู ุงููุชุงุฆุฌ ูุงูุชูุตูุงุช ุงูููุฏุงููุฉ ุญุณุจ ุงููุทุงู ุงูุฌุบุฑุงูู.
        
        ุซุงููุงู: ุงูููุงุฑูุฉ ูุน ุงูุฏุฑุงุณุฉ ุงูุญุงููุฉ:
        ุชุชููุฒ ุฏุฑุงุณุชูู ุงูุญุงููุฉ ุจุฏูุฌ ูุฐู ุงูุฃุฏุจูุงุช ุงููุฑููุนุฉ ูู ูููุฐุฌ ุฅุฌุฑุงุฆู ููุญุฏ ูุณุฏ ุงููุฌูุงุชุ ููู ูุง ูููุฑ ุฑุคูุฉ ุชุฌููุนูุฉ ุดุงููุฉ ุชุชุฌุงูุฒ ุงููุตู ุฅูู ุงูุญู.
        """)

        # 6. ุงูุฑูุงุจุท ุงูุนุงูููุฉ ุงูููุชุฑุญุฉ ููุฏุนู
        st.subheader("๐ ูุฑุงุฌุน ุฅุถุงููุฉ ููุชุฑุญุฉ (ููุตุงุช ุนุงูููุฉ ููุซููุฉ)")
        links = get_global_links("Arabic Linguistics Pedagogy Gap")
        col1, col2, col3, col4 = st.columns(4)
        with col1: st.link_button("Semantic Scholar", links["Semantic Scholar"])
        with col2: st.link_button("Twigale", links["Twigale"])
        with col3: st.link_button("ERIC", links["ERIC"])
        with col4: st.link_button("Google Scholar", links["Google Scholar"])

        # 7. ุฒุฑ ุงูุชุญููู ููุชูุฑูุฑ ุงูููุงุฆู (ุจุตูุบุฉ CSV ูุชูุชุญููุง ูู Excel)
        st.markdown("---")
        st.download_button(
            label="๐ฅ ุชุญููู ูุฑุงุฌุนุฉ ุงูุฃุฏุจูุงุช ูุงููุชุงุฆุฌ (Excel/CSV)",
            data=edited_df.to_csv(index=False).encode('utf-8-sig'),
            file_name="Altwaijer_Final_Systematic_Review.csv",
            mime="text/csv"
        )
        # ุงูุชุฐููู ุงูุฃูุงุฏููู
st.markdown("---")
st.caption("ุฅุดุฑุงู ูุชุทููุฑ: ุฏ. ูุจุฑููุฉ ุงูุชููุฌุฑ - 2026 | ุงููุณุฎุฉ ุงููููุฌูุฉ ุงููุชูุงููุฉ")
